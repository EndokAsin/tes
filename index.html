<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankara NGO Project Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loading-spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Gantt Chart Enhanced */
        .gantt-cell:hover .gantt-tooltip { display: block; }
        .today-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; 
            z-index: 50; border-left: 1px dashed #ef4444; pointer-events: none;
        }
        .today-label {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; font-size: 10px; padding: 2px 4px; rounded: 4px;
            white-space: nowrap; z-index: 51;
        }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex overflow-hidden">
    
    <!-- Toast & Modals -->
    <div id="toast" class="fixed top-5 right-5 z-[70] transform transition-transform translate-x-full duration-300">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-xl p-4 flex items-center pr-8">
            <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
            <div><h4 class="font-bold text-sm text-gray-800">Notifikasi</h4><span id="toast-msg" class="text-sm text-gray-600">Message</span></div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal-generic" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-slate-800" id="modal-generic-title">Modal</h3>
                <button onclick="Core.toggleModal('modal-generic')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-generic-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fas fa-question"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800 mb-2">Konfirmasi</h3>
                <p class="text-sm text-slate-600 mb-6" id="modal-confirm-msg">Apakah Anda yakin?</p>
                <div class="flex justify-center gap-3">
                    <button id="btn-confirm-cancel" class="px-4 py-2 border rounded-xl text-slate-600 hover:bg-slate-50 transition font-medium">Batal</button>
                    <button id="btn-confirm-yes" class="px-4 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition font-bold">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20">
        <div class="p-6 flex items-center border-b border-slate-100">
            <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold mr-3 shadow-green-200 shadow-lg">
                <i class="fas fa-hand-holding-heart"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">SANKARA <span class="text-green-600">PM</span></h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <button id="nav-dashboard" onclick="App.router('dashboard')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-green-50 text-slate-600 flex items-center"><i class="fas fa-chart-pie w-6"></i> Dashboard</button>
            <button id="nav-projects" onclick="App.router('projects')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-green-50 text-slate-600 flex items-center"><i class="fas fa-layer-group w-6"></i> Proyek</button>
            <button id="nav-references" onclick="App.router('references')" class="w-full text-left px-4 py-3 rounded-xl sidebar-item hover:bg-orange-50 text-slate-600 flex items-center"><i class="fas fa-shopping-bag w-6"></i> Referensi Alat</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
            <div class="font-bold text-green-700 text-lg md:hidden"><i class="fas fa-hand-holding-heart mr-2"></i>SANKARA PM</div>
            <div class="hidden md:block font-bold text-slate-800">Project Management Workspace</div>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar relative"></div>
    </main>

    <script>
        // --- MODULE 1: CORE & CONFIG ---
        const Core = {
            supabase: window.supabase.createClient('https://ljhcszzmuaourbwwozmf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaGNzenptdWFvdXJid3dvem1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY4OTcsImV4cCI6MjA3OTg0Mjg5N30.SnitqGcGWVqBrGD5OOB5RasA6u1rDCqpuKir0gLG_b8'),
            SUPABASE_URL: 'https://ljhcszzmuaourbwwozmf.supabase.co',
            SOP_STEPS: [
                { id: 1, name: "Submit Proposal", desc: "H-18", requiresApproval: false }, 
                { id: 2, name: "Media & Finance", desc: "H-15", requiresApproval: true },
                { id: 3, name: "Rekrutmen & Beli", desc: "H-15 s/d H-5", requiresApproval: true }, 
                { id: 4, name: "First Meet", desc: "H-3", requiresApproval: false },
                { id: 5, name: "Kegiatan", desc: "H-0", requiresApproval: false },
                { id: 6, name: "Laporan", desc: "H+2", requiresApproval: true }
            ],
            formatDate: (s) => s ? new Date(s).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-',
            formatCurrency: (n) => n ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n) : 'Rp 0',
            showToast: (msg) => {
                const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg;
                t.classList.remove('translate-x-full'); setTimeout(() => t.classList.add('translate-x-full'), 3000);
            },
            toggleModal: (id) => document.getElementById(id).classList.toggle('hidden'),
            confirm: (msg) => new Promise((resolve) => {
                document.getElementById('modal-confirm-msg').textContent = msg;
                document.getElementById('modal-confirm').classList.remove('hidden');
                document.getElementById('btn-confirm-yes').onclick = () => { document.getElementById('modal-confirm').classList.add('hidden'); resolve(true); };
                document.getElementById('btn-confirm-cancel').onclick = () => { document.getElementById('modal-confirm').classList.add('hidden'); resolve(false); };
            }),
            openGenericModal: (title, html, onSubmitFn) => {
                document.getElementById('modal-generic-title').innerText = title;
                document.getElementById('modal-generic-content').innerHTML = html;
                if(onSubmitFn) document.querySelector('#modal-generic-content form').onsubmit = onSubmitFn;
                Core.toggleModal('modal-generic');
            },
            fetchRegions: async () => {
                const { data, error } = await Core.supabase.from('pm_regions').select('*').order('name');
                return error ? [] : data;
            },
            checkDB: async () => { await Core.supabase.from('projects').select('id').limit(1); }
        };

        const UserModule = {
            projects: [], activeProjectId: null, filterRegion: 'all', dashboardFilterRegion: 'all', references: [], 

            loadData: async () => {
                const { data } = await Core.supabase.from('projects').select('*').order('event_date');
                UserModule.projects = data || [];
            },
            loadReferences: async () => {
                const { data } = await Core.supabase.from('event_tools_references').select('*').order('product_name');
                UserModule.references = data || [];
            },
            renderReferences: async (container) => {
                await UserModule.loadReferences();
                container.innerHTML = `<div class="fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Referensi Alat & Bahan</h2><button onclick="UserModule.addReferenceModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition">+ Tambah Referensi</button></div>${UserModule.references.length === 0 ? `<div class="bg-white rounded-xl border border-dashed border-slate-300 p-10 text-center text-slate-500"><i class="fas fa-shopping-bag text-4xl mb-3 text-slate-300"></i><p>Belum ada data.</p></div>` : `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">${UserModule.references.map(i=>`<div class="bg-white p-4 rounded border shadow-sm"><h3 class="font-bold">${i.product_name}</h3><a href="${i.purchase_link}" target="_blank" class="text-blue-500 text-sm truncate block">Link Pembelian</a></div>`).join('')}</div>`}</div>`;
            },
            addReferenceModal: () => {
                Core.openGenericModal('Tambah Referensi', `<form onsubmit="event.preventDefault(); UserModule.saveReference(this)"><label class="block text-xs font-bold text-slate-500 mb-1">NAMA ALAT</label><input name="product_name" class="w-full border p-2 rounded mb-2" placeholder="Nama Alat" required><label class="block text-xs font-bold text-slate-500 mb-1">LINK</label><input name="purchase_link" class="w-full border p-2 rounded mb-4" placeholder="Link" required><button class="w-full bg-orange-500 text-white py-2 rounded">Simpan</button></form>`);
            },
            saveReference: async (form) => {
                const d = Object.fromEntries(new FormData(form)); delete d.id;
                await Core.supabase.from('event_tools_references').insert(d);
                Core.showToast('Disimpan'); Core.toggleModal('modal-generic'); UserModule.renderReferences(document.getElementById('content-area'));
            },
            renderDashboard: async (container) => {
                const regions = await Core.fetchRegions();
                const filtered = UserModule.dashboardFilterRegion === 'all' ? UserModule.projects : UserModule.projects.filter(p => p.regional === UserModule.dashboardFilterRegion);
                container.innerHTML = `<div class="fade-in"><h2 class="text-2xl font-bold mb-6">Dashboard</h2><div class="flex gap-2 mb-4"><select onchange="UserModule.dashboardFilterRegion=this.value; UserModule.renderDashboard(document.getElementById('content-area'))" class="border rounded px-3 py-2"><option value="all">Semua Regional</option>${regions.map(r=>`<option value="${r.name}" ${UserModule.dashboardFilterRegion===r.name?'selected':''}>${r.name}</option>`).join('')}</select></div><div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-white p-6 rounded border shadow-sm text-center"><span class="text-3xl font-bold">${filtered.length}</span><br>Total Proyek</div></div><div class="bg-white p-6 rounded border shadow-sm overflow-x-auto">${UserModule.renderGanttChart(filtered)}</div></div>`;
            },
            renderProjectList: async (container) => {
                const regions = await Core.fetchRegions();
                const filtered = UserModule.filterRegion === 'all' ? UserModule.projects : UserModule.projects.filter(p => p.regional === UserModule.filterRegion);
                container.innerHTML = `<div class="fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Daftar Proyek</h2><div class="flex gap-2"><select onchange="UserModule.filterRegion=this.value;App.router('projects')" class="border rounded px-3 py-2"><option value="all">Semua Regional</option>${regions.map(r=>`<option value="${r.name}" ${UserModule.filterRegion===r.name?'selected':''}>${r.name}</option>`).join('')}</select><button onclick="UserModule.openNewProjectModal()" class="bg-green-600 text-white px-4 py-2 rounded">+ Buat Proyek</button></div></div><div class="grid gap-4">${filtered.map(p=>`<div onclick="UserModule.openProjectDetail('${p.id}')" class="bg-white p-5 rounded-xl border shadow-sm hover:shadow-md cursor-pointer"><div class="flex justify-between mb-2"><span class="bg-slate-800 text-white text-xs px-2 py-1 rounded">${p.regional}</span><span class="text-xs text-slate-500">${Core.formatDate(p.event_date)}</span></div><h3 class="font-bold text-lg">${p.title}</h3><p class="text-sm text-slate-500">${p.status}</p></div>`).join('')}</div></div>`;
            },
            openNewProjectModal: async () => {
                const regions = await Core.fetchRegions();
                Core.openGenericModal('Proyek Baru', `<form onsubmit="event.preventDefault();UserModule.createProject(this)"><input name="title" placeholder="Nama" class="w-full border p-2 rounded mb-2" required><select name="regional" class="w-full border p-2 rounded mb-2" required><option value="">Pilih Regional</option>${regions.map(r=>`<option>${r.name}</option>`).join('')}</select><input type="date" name="event_date" class="w-full border p-2 rounded mb-4" required><button class="w-full bg-green-600 text-white py-2 rounded">Simpan</button></form>`);
            },
            createProject: async (form) => {
                const d = Object.fromEntries(new FormData(form)); d.status = 'Tahap 1: Submit Proposal';
                const { data, error } = await Core.supabase.from('projects').insert(d).select();
                if(data) {
                    await Core.supabase.from('events').upsert({region: d.regional, name: d.title, budget_limit: 0, status: 'active'}, {onConflict: 'region,name'});
                    Core.toggleModal('modal-generic'); Core.showToast('Proyek Dibuat'); App.router('projects');
                }
            },
            openProjectDetail: async (id, stepId = 1) => {
                UserModule.activeProjectId = id;
                const container = document.getElementById('content-area'); container.innerHTML = '<div class="flex h-full items-center justify-center"><div class="loading-spinner"></div></div>';
                const { data: p } = await Core.supabase.from('projects').select('*').eq('id', id).single();
                if(!p) return App.router('projects');
                const [rundowns, budgets, volunteers, approvals, games] = await Promise.all([
                    Core.supabase.from('rundowns').select('*').eq('project_id', id).order('time_start'),
                    Core.supabase.from('budgets').select('*').eq('project_id', id).order('id'),
                    Core.supabase.from('volunteers').select('*').eq('project_id', id),
                    Core.supabase.from('project_approvals').select('*').eq('project_id', id),
                    Core.supabase.from('project_games').select('*').eq('project_id', id)
                ]);
                UserModule.renderDetailView(container, p, { rundowns: rundowns.data, budgets: budgets.data, volunteers: volunteers.data, approvals: approvals.data, games: games.data }, stepId);
            },
            renderDetailView: (container, p, r, sid) => {
                const status = r.approvals?.find(a => a.step_number === sid)?.status || 'pending';
                const step = Core.SOP_STEPS.find(s => s.id === sid);
                let controls = '';
                if(step.requiresApproval) {
                    if(status === 'pending') controls = `<button onclick="UserModule.submitApproval('${p.id}', ${sid})" class="bg-blue-600 text-white w-full py-2 rounded font-bold">Ajukan ke Finance</button>`;
                    else if(status === 'submitted') {
                        controls = `<div class="bg-yellow-50 text-yellow-800 p-4 rounded text-center border border-yellow-200"><i class="fas fa-clock mb-2 text-2xl"></i><p class="font-bold">Menunggu Verifikasi Finance</p><p class="text-sm">Silakan hubungi Admin Finance (NGO Finance App) untuk persetujuan RAB.</p><button onclick="UserModule.openProjectDetail('${p.id}', ${sid})" class="mt-2 text-xs bg-white border px-3 py-1 rounded hover:bg-gray-50"><i class="fas fa-sync"></i> Cek Status</button></div>`;
                    }
                    else if(status === 'approved') controls = `<div class="bg-green-50 text-green-800 p-3 rounded text-center font-bold mb-2 border border-green-200">Disetujui oleh Finance</div>${sid<6?`<button onclick="UserModule.openProjectDetail('${p.id}',${sid+1})" class="bg-slate-100 w-full py-2 rounded">Lanjut Step ${sid+1}</button>`:''}`;
                    else controls = `<div class="bg-red-50 text-red-800 p-3 rounded text-center mb-2">Ditolak Finance: ${r.approvals.find(a=>a.step_number===sid)?.notes || '-'}</div><button onclick="UserModule.submitApproval('${p.id}',${sid})" class="bg-slate-600 text-white w-full py-2 rounded">Ajukan Ulang</button>`;
                } else {
                    controls = `<button onclick="UserModule.openProjectDetail('${p.id}',${sid+1})" class="bg-teal-600 text-white w-full py-2 rounded font-bold">Selesai, Lanjut</button>`;
                }
                const stepsHtml = Core.SOP_STEPS.map(s => {
                    const st = r.approvals?.find(a => a.step_number === s.id)?.status || 'pending';
                    return `<button onclick="UserModule.openProjectDetail('${p.id}',${s.id})" class="flex flex-col items-center min-w-[100px] p-2 rounded-xl mx-1 ${sid===s.id?'bg-green-600 text-white':'bg-white text-slate-600 border'}"><div class="text-xs font-bold">Tahap ${s.id}</div><div class="text-[10px]">${s.name}</div><i class="fas ${st==='approved'?'fa-check text-green-500':'fa-circle text-slate-300'} text-xs absolute -top-1 -right-1 bg-white rounded-full p-1 border"></i></button>`;
                }).join('');
                
                let body = `<div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded mb-6"><p class="font-bold text-sm">Deadline: ${step.desc} (Dari Hari H)</p></div>`;
                if (sid === 1) {
                    const gameRows = (r.games||[]).map(g => { const gJson = JSON.stringify(g).replace(/"/g, '&quot;'); return `<div class="flex justify-between items-center border-b pb-1"><div class="flex-1"><div class="font-medium">${g.title}</div><div class="text-xs text-blue-500 truncate"><a href="${g.link}" target="_blank">${g.link||'-'}</a></div></div><div class="flex gap-1 ml-2"><button onclick="UserModule.editGame('${p.id}', ${gJson})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button><button onclick="UserModule.deleteItem('project_games', '${g.id}', '${p.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
                    body += `<label class="text-xs font-bold text-slate-500">TARGET AUDIENCE</label><input value="${p.target_audience||''}" onchange="UserModule.updateField('${p.id}','target_audience',this.value)" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold text-slate-500">KONSEP ACARA</label><textarea onchange="UserModule.updateField('${p.id}','concept_note',this.value)" class="w-full border p-2 rounded mb-4" rows="4">${p.concept_note||''}</textarea><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">Games & Referensi</h4><button onclick="UserModule.addItemModal('project_games','${p.id}')" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 transition">+ Tambah</button></div><div class="bg-slate-50 p-3 rounded border mb-4 text-sm space-y-2">${gameRows.length ? gameRows : '<div class="text-slate-400 italic">Belum ada games/referensi</div>'}</div>`;
                } else if (sid === 2) {
                    const total = (r.budgets||[]).reduce((a,b)=>a+(b.total_price||0),0);
                    // Modified RAB Rows with Invoice Upload Button
                    const rabRows = (r.budgets||[]).map(b => {
                        const bJson = JSON.stringify(b).replace(/"/g, '&quot;');
                        const hasInvoice = b.invoice_url ? true : false;
                        return `
                        <div class="flex justify-between items-center border-b pb-2 pt-1">
                            <div class="flex-1">
                                <div class="font-medium">${b.item_name} <span class="text-xs text-slate-500">(${b.quantity}x @ ${Core.formatCurrency(b.unit_price)})</span></div>
                                ${hasInvoice ? `<a href="${b.invoice_url}" target="_blank" class="text-[10px] text-green-600 bg-green-50 px-1 rounded border border-green-200"><i class="fas fa-file-invoice"></i> Invoice/VA Terupload</a>` : `<span class="text-[10px] text-orange-400 bg-orange-50 px-1 rounded">Belum ada invoice</span>`}
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold text-slate-700">${Core.formatCurrency(b.total_price)}</span>
                                <div class="flex gap-1">
                                    <label class="cursor-pointer text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded border" title="Upload Invoice/Nota/VA">
                                        <i class="fas fa-upload"></i>
                                        <input type="file" class="hidden" onchange="UserModule.uploadBudgetProof('${p.id}', '${b.id}', this.files[0])">
                                    </label>
                                    <button onclick="UserModule.editBudget('${p.id}', ${bJson})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button>
                                    <button onclick="UserModule.deleteItem('budgets', '${b.id}', '${p.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    
                    const rundownRows = (r.rundowns||[]).map(rd => { const rJson = JSON.stringify(rd).replace(/"/g, '&quot;'); return `<div class="flex gap-2 border-b pb-1 justify-between items-center"><div class="flex-1 flex gap-2"><span class="font-mono bg-white border px-1 rounded text-xs flex items-center">${rd.time_start}-${rd.time_end}</span><span class="text-sm">${rd.activity}</span></div><div class="flex gap-1"><button onclick="UserModule.editRundown('${p.id}', ${rJson})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button><button onclick="UserModule.deleteItem('rundowns', '${rd.id}', '${p.id}')" class="text-red-400 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
                    body += `<div class="flex justify-between mb-2"><h4 class="font-bold">RAB (Sinkron ke Finance)</h4><button onclick="UserModule.addItemModal('budgets','${p.id}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 transition">+ Item</button></div><div class="bg-slate-50 p-3 rounded border mb-4 text-sm space-y-2">${rabRows}<div class="flex justify-between font-bold pt-2 border-t mt-2 text-blue-700"><span>Total</span><span>${Core.formatCurrency(total)}</span></div></div><div class="flex justify-between mb-2"><h4 class="font-bold">Rundown</h4><button onclick="UserModule.openRundownModal('${p.id}')" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 transition">+ Kegiatan</button></div><div class="bg-slate-50 p-3 rounded border mb-4 text-sm space-y-1">${rundownRows.length ? rundownRows : '<div class="text-slate-400 italic">Belum ada rundown</div>'}</div><label class="text-xs font-bold text-slate-500">LINK POSTER</label><input value="${p.poster_link||''}" onchange="UserModule.updateField('${p.id}','poster_link',this.value)" class="w-full border p-2 rounded">`;
                } else if (sid === 3) {
                     const volRows = (r.volunteers||[]).map(v => { const vJson = JSON.stringify(v).replace(/"/g, '&quot;'); return `<div class="bg-slate-50 p-2 rounded border text-sm flex justify-between items-center"><span>${v.role_name}</span><div class="flex gap-2 font-bold items-center"><span>${v.count}</span><div class="flex gap-1 border-l pl-2 ml-2 border-slate-300"><button onclick="UserModule.editVolunteer('${p.id}', ${vJson})" class="text-blue-500 font-normal hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="UserModule.deleteItem('volunteers', '${v.id}', '${p.id}')" class="text-red-400 font-normal hover:text-red-600"><i class="fas fa-trash"></i></button></div></div></div>`; }).join('');
                     body += `<div class="flex justify-between mb-2"><h4 class="font-bold">Relawan</h4><button onclick="UserModule.addItemModal('volunteers','${p.id}')" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded hover:bg-orange-200 transition">+ Divisi</button></div><div class="grid grid-cols-2 gap-2 mb-4">${volRows}</div><label class="text-xs font-bold text-slate-500">STATUS LOGISTIK</label><select onchange="UserModule.updateField('${p.id}','purchase_status',this.value)" class="w-full border p-2 rounded"><option ${p.purchase_status==='Belum'?'selected':''}>Belum</option><option ${p.purchase_status==='Proses'?'selected':''}>Proses</option><option ${p.purchase_status==='Selesai'?'selected':''}>Selesai</option></select>${status === 'approved' ? `<button onclick="PDFService.generate('${p.id}')" class="w-full mt-4 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition"><i class="fas fa-file-pdf mr-2"></i> Download PDF (Progress Tahap 3)</button>` : ''}`;
                } else if (sid === 4) {
                    body += `<label class="text-xs font-bold text-slate-500">CATATAN FIRST MEET</label><textarea onchange="UserModule.updateField('${p.id}','firstmeet_notes',this.value)" class="w-full border p-2 rounded mb-4" rows="4">${p.firstmeet_notes||''}</textarea><div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300"><h4 class="font-bold text-slate-700 text-sm mb-2"><i class="fas fa-cloud-upload-alt mr-2"></i>Bukti First Meet (Foto/Absensi)</h4><div class="space-y-3"><input type="file" onchange="UserModule.uploadFile('${p.id}','evidence',this.files[0],'firstmeet_proof')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><input value="${p.firstmeet_proof||''}" onchange="UserModule.updateField('${p.id}','firstmeet_proof',this.value)" class="w-full border p-2 rounded text-sm bg-white" placeholder="Tempel Link Google Drive / Dropbox disini">${p.firstmeet_proof ? `<div class="mt-2"><img src="${p.firstmeet_proof}" class="h-32 rounded border shadow-sm object-cover hover:h-auto"><a href="${p.firstmeet_proof}" target="_blank" class="text-xs text-blue-500 underline block mt-1">Lihat Gambar Full</a></div>` : ''}</div></div>`;
                } else if (sid === 5) {
                     body += `<label class="text-xs font-bold text-slate-500">CATATAN EVALUASI EVENT</label><textarea onchange="UserModule.updateField('${p.id}','eventday_notes',this.value)" class="w-full border p-2 rounded" rows="5">${p.eventday_notes||''}</textarea>`;
                } else if (sid === 6) {
                     body += `<label class="text-xs font-bold text-slate-500">ISI LAPORAN</label><textarea onchange="UserModule.updateField('${p.id}','report_content',this.value)" class="w-full border p-2 rounded mb-4" rows="5">${p.report_content||''}</textarea><div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300 mb-4"><h4 class="font-bold text-slate-700 text-sm mb-2"><i class="fas fa-cloud-upload-alt mr-2"></i>Bukti Laporan Akhir (Foto Kegiatan)</h4><div class="space-y-3"><input type="file" onchange="UserModule.uploadFile('${p.id}','evidence',this.files[0],'report_proof')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><input value="${p.report_proof||''}" onchange="UserModule.updateField('${p.id}','report_proof',this.value)" class="w-full border p-2 rounded text-sm bg-white" placeholder="Tempel Link Google Drive / Dropbox disini">${p.report_proof ? `<div class="mt-2"><img src="${p.report_proof}" class="h-32 rounded border shadow-sm object-cover hover:h-auto"><a href="${p.report_proof}" target="_blank" class="text-xs text-blue-500 underline block mt-1">Lihat Gambar Full</a></div>` : ''}</div></div>${status==='approved' ? `<button onclick="PDFService.generate('${p.id}')" class="w-full bg-red-600 text-white py-3 rounded font-bold hover:bg-red-700 transition"><i class="fas fa-file-pdf mr-2"></i> Export Laporan PDF Lengkap</button>` : ''}`;
                }

                container.innerHTML = `<div class="fade-in pb-20"><button onclick="App.router('projects')" class="text-sm mb-4"><i class="fas fa-arrow-left"></i> Kembali</button><h1 class="text-2xl font-bold mb-4">${p.title}</h1><div class="flex overflow-x-auto pb-4 mb-4">${stepsHtml}</div><div class="bg-white rounded-2xl p-6 border shadow-sm mb-6">${body}<div class="mt-4 pt-4 border-t">${controls}</div></div></div>`;
            },
            
            // --- NEW: Upload Budget Proof (Invoice) Logic ---
            uploadBudgetProof: async (pid, budgetId, file) => {
                if(!file) return;
                Core.showToast('Mengupload Invoice...');
                const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `invoices/${pid}/${Date.now()}_${safeName}`;
                
                const { error: uploadError } = await Core.supabase.storage.from('evidence').upload(fileName, file);
                if(uploadError) { Core.showToast('Gagal Upload: ' + uploadError.message); return; }
                
                const { data } = Core.supabase.storage.from('evidence').getPublicUrl(fileName);
                
                const { error: dbError } = await Core.supabase.from('budgets').update({ invoice_url: data.publicUrl }).eq('id', budgetId);
                
                if(dbError) { Core.showToast('Gagal Simpan DB'); } 
                else { 
                    Core.showToast('Invoice Berhasil Diupload'); 
                    UserModule.openProjectDetail(pid, 2); // Refresh UI to show status
                }
            },

            addItemModal: (t, pid) => {
                let html = t==='budgets' ? `<input name="item_name" placeholder="Item" class="w-full border p-2 mb-2" required><div class="flex gap-2"><input name="quantity" type="number" placeholder="Qty" class="w-full border p-2"><input name="unit_price" type="number" placeholder="Harga" class="w-full border p-2"></div>` : '';
                Core.openGenericModal('Tambah', `<form onsubmit="event.preventDefault();UserModule.saveItem('${t}','${pid}',this)">${html}<button class="w-full bg-green-600 text-white py-2 mt-4 rounded">Simpan</button></form>`);
            },
            saveItem: async (table, pid, form) => {
                const d = Object.fromEntries(new FormData(form)); d.project_id = pid;
                if(table==='budgets') d.total_price = (d.quantity||0) * (d.unit_price||0);
                await Core.supabase.from(table).insert(d);
                if(table==='budgets') await UserModule.syncBudgetToFinance(pid);
                Core.toggleModal('modal-generic');
                let step = table === 'budgets' || table === 'rundowns' ? 2 : (table === 'volunteers' ? 3 : 1);
                UserModule.openProjectDetail(pid, step);
            },
            deleteItem: async (table, id, pid) => {
                if(!await Core.confirm('Hapus?')) return;
                await Core.supabase.from(table).delete().eq('id', id);
                if(table==='budgets') await UserModule.syncBudgetToFinance(pid);
                let step = table === 'budgets' || table === 'rundowns' ? 2 : (table === 'volunteers' ? 3 : 1);
                UserModule.openProjectDetail(pid, step);
            },
            syncBudgetToFinance: async (pid) => {
                const { data: budgets } = await Core.supabase.from('budgets').select('total_price').eq('project_id', pid);
                const total = budgets ? budgets.reduce((sum, item) => sum + (item.total_price || 0), 0) : 0;
                const { data: p } = await Core.supabase.from('projects').select('title, regional').eq('id', pid).single();
                if (p) await Core.supabase.from('events').upsert({ region: p.regional, name: p.title, budget_limit: total, status: 'active' }, { onConflict: 'region,name' });
            },
            submitApproval: async (id, step) => { await Core.supabase.from('project_approvals').upsert({project_id: id, step_number: step, status: 'submitted'}); Core.showToast('Diajukan ke Finance'); UserModule.openProjectDetail(id, step); },
            renderGanttChart: (list) => {
                if(!list.length) return '';
                const h = Array.from({length:20},(_,i)=>`<div class="w-8 shrink-0 text-center text-xs border-r">${i-10}</div>`).join('');
                return `<div class="min-w-[600px]"><div class="flex border-b pb-1"><div class="w-40 shrink-0">Project</div><div class="flex">${h}</div></div>${list.map(p=>`<div class="flex border-b py-1 hover:bg-slate-50"><div class="w-40 shrink-0 truncate pr-2 text-sm">${p.title}</div><div class="flex">${Array.from({length:20},(_,i)=>`<div class="w-8 shrink-0 border-r h-4 ${i===10?'bg-green-500':''}"></div>`).join('')}</div></div>`).join('')}</div>`;
            },
            openEditProjectModal: (p) => { Core.openGenericModal('Edit', `<form onsubmit="event.preventDefault();UserModule.updateProjectDetails(this,'${p.id}')"><label>Nama</label><input name="title" value="${p.title}" class="w-full border p-2 mb-2"><label>Tanggal</label><input type="date" name="event_date" value="${p.event_date}" class="w-full border p-2 mb-2"><button class="w-full bg-blue-600 text-white py-2 rounded">Simpan</button></form>`); },
            updateProjectDetails: async (form, pid) => { const d = Object.fromEntries(new FormData(form)); const { error } = await Core.supabase.from('projects').update(d).eq('id', pid); if (!error) { Core.showToast('Informasi proyek diperbarui'); Core.toggleModal('modal-generic'); await UserModule.syncBudgetToFinance(pid); if (UserModule.activeProjectId) UserModule.openProjectDetail(pid, 1); else App.router('projects'); } else Core.showToast('Gagal update: ' + error.message); },
            updateField: async (id, col, val) => { const { error } = await Core.supabase.from('projects').update({[col]: val}).eq('id', id); if(error) { Core.showToast('Gagal Simpan DB: ' + error.message); return false; } if (col === 'title' || col === 'regional') UserModule.syncBudgetToFinance(id); Core.showToast('Tersimpan'); return true; },
            uploadFile: async (pid, bucket, file, dbCol) => { if(!file || file.size > 500 * 1024) return; const fileName = `${pid}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`; const { error } = await Core.supabase.storage.from(bucket).upload(fileName, file); if(!error) { const { data } = Core.supabase.storage.from(bucket).getPublicUrl(fileName); const success = await UserModule.updateField(pid, dbCol, data.publicUrl); if(success) setTimeout(() => UserModule.openProjectDetail(pid, dbCol === 'firstmeet_proof' ? 4 : 6), 1000); } },
        
            // PDF Generation logic
        };

        // Simplified PDFService
        const PDFService = {
             generate: async (pid) => {
                 try {
                     Core.showToast('Menyiapkan PDF...');
                     const { data: p } = await Core.supabase.from('projects').select('*').eq('id', pid).single();
                     const { data: b } = await Core.supabase.from('budgets').select('*').eq('project_id', pid);
                     const doc = new window.jspdf.jsPDF();
                     doc.text(`Laporan: ${p.title}`, 10, 10);
                     doc.autoTable({ head: [['Item', 'Qty', 'Harga', 'Total']], body: b.map(x => [x.item_name, x.quantity, x.unit_price, x.total_price]) });
                     doc.save(`Laporan_${p.title}.pdf`);
                 } catch(e) { console.error(e); }
             }
        };

        const App = {
            init: () => { Core.initSupabase(); Core.checkDB(); App.router('projects'); },
            router: (r) => {
                const c = document.getElementById('content-area');
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('bg-green-50', 'text-green-700', 'bg-orange-50', 'bg-blue-50'));
                if(r==='dashboard'){ UserModule.loadData().then(()=>UserModule.renderDashboard(c)); }
                if(r==='projects'){ UserModule.loadData().then(()=>UserModule.renderProjectList(c)); }
                if(r==='references'){ UserModule.renderReferences(c); }
            }
        };
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
